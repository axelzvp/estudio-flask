<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiStudy - Panel de Maestro</title>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\$$', '\$$']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS Propio -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* Estilos adicionales espec√≠ficos para el panel de maestro */
        .floating-new-question {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-glow);
            transition: var(--transition);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .floating-new-question:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .question-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .question-actions .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .question-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 20px;
            transition: var(--transition);
        }
        
        .question-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .question-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .question-content {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 15px;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .question-content.expanded {
            max-height: none;
            overflow: visible;
        }
        
        .question-content .read-more {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--bg-card);
            padding-left: 20px;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .question-stats {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .question-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-top: 20px;
        }
        
        .empty-icon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 20px;
            text-align: center;
        }
        
        .stat-box .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .stat-box .label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .page-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn:hover:not(.active) {
            background: var(--border-color);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Estilos para carga masiva */
        .progress-container {
            margin-top: 20px;
            position: relative;
            height: 30px;
            background: var(--bg-elevated);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
        }
        
        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
        }
        
        .result-success {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: var(--success);
        }
        
        .result-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }
        
        .result-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: var(--accent);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="logo-text">
                <h1>MultiStudy</h1>
                <p id="userGreeting">Panel de Maestro</p>
            </div>
        </div>
        
        <nav class="menu">
            <div class="menu-item active" data-page="questions">
                <i class="fas fa-list"></i>
                <span>Banco de Preguntas</span>
            </div>
            <div class="menu-item" data-page="stats">
                <i class="fas fa-chart-bar"></i>
                <span>Estad√≠sticas</span>
            </div>
            <div class="menu-item" data-page="study">
                <i class="fas fa-book-open"></i>
                <span>Modo Estudio</span>
            </div>
            <div class="menu-item" id="openModalBtn">
                <i class="fas fa-plus-circle"></i>
                <span>Nueva Pregunta</span>
            </div>
        </nav>
        
        <div class="stats-sidebar">
            <div class="stats-header">
                <i class="fas fa-chart-pie"></i>
                <span>Resumen</span>
            </div>
            <div class="stat-mini">
                <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
                <div class="stat-info">
                    <span class="stat-value" id="sidebarTotal">0</span>
                    <span class="stat-label">Preguntas</span>
                </div>
            </div>
            <div class="stat-mini">
                <div class="stat-icon"><i class="fas fa-book"></i></div>
                <div class="stat-info">
                    <span class="stat-value" id="sidebarSubjects">0</span>
                    <span class="stat-label">Materias</span>
                </div>
            </div>
            <div class="stat-mini">
                <div class="stat-icon"><i class="fas fa-eye"></i></div>
                <div class="stat-info">
                    <span class="stat-value" id="sidebarShown">0</span>
                    <span class="stat-label">Estudiadas</span>
                </div>
            </div>
        </div>
        
        <div class="user-profile">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="userName"></span>
                    <span class="user-role" id="userRole">üë®‚Äçüè´ Maestro</span>
                </div>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- P√°gina: Banco de Preguntas -->
        <div class="page active" id="questionsPage">
            <div class="page-header">
                <div class="page-header-content">
                    <h2 class="page-title">
                        <i class="fas fa-list"></i> 
                        Banco de Preguntas
                    </h2>
                    <p class="page-subtitle">Administra todas las preguntas del sistema</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-ghost" id="showHelpBtn">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <button class="btn btn-primary" id="openModalFromListBtn">
                        <i class="fas fa-plus"></i>
                        Nueva Pregunta
                    </button>
                    <!-- En el page-header de la p√°gina de preguntas, a√±ade esto junto a los otros botones -->
                    <button class="btn btn-success" onclick="openBulkModal()" style="margin-left: 10px;">
                        <i class="fas fa-file-import"></i>
                        Carga Masiva
                    </button>
                </div>
            </div>
            
            <!-- Resumen estad√≠stico -->
            <div class="stats-summary">
                <div class="stat-box">
                    <div class="number" id="totalQuestionsStat">0</div>
                    <div class="label">Total de Preguntas</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalSubjectsStat">0</div>
                    <div class="label">Materias Diferentes</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalShownStat">0</div>
                    <div class="label">Veces Estudiadas</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalCorrectStat">0</div>
                    <div class="label">Respuestas Correctas</div>
                </div>
            </div>
            
            <!-- Filtros y b√∫squeda -->
            <div class="filter-container">
                <select class="filter-select" id="subjectFilter">
                    <option value="todos">Todas las materias</option>
                </select>
                
                <select class="filter-select" id="topicFilter">
                    <option value="todos">Todos los temas</option>
                </select>
                
                <select class="filter-select" id="universityFilter">
                    <option value="todos">Todas las universidades</option>
                    <option value="UNAM">UNAM</option>
                    <option value="IPN">IPN</option>
                    <option value="UAM">UAM</option>
                    <option value="TEC">TEC</option>
                    <option value="EXANI">EXANI</option>
                </select>
                
                <select class="filter-select" id="typeFilter">
                    <option value="todos">Todos los tipos</option>
                    <option value="opciones">Opciones m√∫ltiples</option>
                    <option value="abierta">Respuesta abierta</option>
                </select>
                
                <button class="btn btn-outline btn-sm" id="clearFiltersBtn">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Buscar en preguntas y respuestas...">
                <button class="btn btn-primary" id="searchBtn">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
            
            <!-- Lista de preguntas -->
            <div class="questions-grid" id="questionsList">
                <!-- Las preguntas se cargan din√°micamente -->
            </div>
            
            <!-- Estado vac√≠o -->
            <div id="noQuestionsMessage" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3>No hay preguntas todav√≠a</h3>
                <p>Comienza agregando tu primera pregunta</p>
                <button class="btn btn-primary" id="addFirstQuestionBtn">
                    <i class="fas fa-plus"></i>
                    Agregar Primera Pregunta
                </button>
            </div>
            
            <!-- Sin resultados de b√∫squeda -->
            <div id="noSearchResults" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3>Sin resultados</h3>
                <p>No hay preguntas que coincidan con tu b√∫squeda</p>
                <button class="btn btn-outline" id="clearSearchBtn">
                    <i class="fas fa-times"></i> Limpiar B√∫squeda
                </button>
            </div>
            
            <!-- Paginaci√≥n -->
            <div class="pagination" id="pagination" style="display: none;">
                <button class="page-btn" id="prevPageBtn" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="pageInfo" style="color: var(--text-muted); font-size: 0.9rem;">
                    P√°gina 1 de 1
                </span>
                <button class="page-btn" id="nextPageBtn" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <!-- P√°gina: Estad√≠sticas -->
        <div class="page" id="statsPage">
            <div class="page-header">
                <div class="page-header-content">
                    <h2 class="page-title">
                        <i class="fas fa-chart-bar"></i> 
                        Estad√≠sticas Detalladas
                    </h2>
                    <p class="page-subtitle">An√°lisis completo del sistema</p>
                </div>
            </div>
            
            <!-- Gr√°ficos principales -->
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-card-header">
                        <i class="fas fa-chart-pie"></i>
                        <span>Distribuci√≥n por Materias</span>
                    </div>
                    <div class="stats-card-body">
                        <div id="subjectsChart"></div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-header">
                        <i class="fas fa-university"></i>
                        <span>Distribuci√≥n por Universidad</span>
                    </div>
                    <div class="stats-card-body">
                        <div id="universitiesChart"></div>
                    </div>
                </div>
            </div>
            
            <!-- Estad√≠sticas detalladas -->
            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stats-card">
                    <div class="stats-card-header">
                        <i class="fas fa-star"></i>
                        <span>Temas m√°s Populares</span>
                    </div>
                    <div class="stats-card-body">
                        <div id="topTopicsList"></div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-header">
                        <i class="fas fa-check-circle"></i>
                        <span>Rendimiento</span>
                    </div>
                    <div class="stats-card-body">
                        <div id="performanceStats"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tabla de preguntas m√°s vistas -->
            <div class="stats-card" style="margin-top: 20px;">
                <div class="stats-card-header">
                    <i class="fas fa-eye"></i>
                    <span>Preguntas M√°s Visitadas</span>
                </div>
                <div class="stats-card-body">
                    <div id="mostViewedQuestions">
                        <!-- Se carga din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- P√°gina: Modo Estudio (para que el maestro tambi√©n pueda estudiar) -->
        <div class="page" id="studyPage">
            <div class="page-header">
                <div class="page-header-content">
                    <h2 class="page-title">
                        <i class="fas fa-book-open"></i> 
                        Modo Estudio
                    </h2>
                    <p class="page-subtitle">Prueba las preguntas como lo har√≠a un alumno</p>
                </div>
            </div>
            
            <!-- Selector de materias -->
            <div class="study-selector" id="subjectSelectorContainer">
                <div class="study-selector-header">
                    <div class="section-title">
                        <i class="fas fa-th-large"></i>
                        <span>Selecciona una materia</span>
                    </div>
                </div>
                
                <div class="study-selector-body">
                    <div class="subjects-grid" id="subjectButtons">
                        <!-- Las materias se cargan dinamicamente -->
                    </div>
                    
                    <!-- Temas -->
                    <div id="topicSelectorContainer" class="topics-section" style="display: none;">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-folder-open"></i>
                                <span>Temas de <strong id="currentSubjectName"></strong></span>
                            </div>
                        </div>
                        <div class="topics-chips" id="studyTopicButtons">
                            <!-- Los temas se cargan aqui -->
                        </div>
                    </div>
                    
                    <!-- Boton para comenzar -->
                    <div class="study-action">
                        <button class="btn btn-primary btn-lg" id="getQuestionBtn">
                            <i class="fas fa-dice"></i>
                            <span>Obtener Pregunta</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n flotante para nueva pregunta -->
    <button class="floating-new-question" id="floatingNewQuestionBtn" title="Nueva Pregunta">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- MODAL DE PREGUNTA (Modo Estudio) -->
    <div class="modal-overlay" id="studyQuestionModal" style="display:none;">
      <div class="modal study-modal">
        <div class="modal-header">
          <div class="question-badges">
            <span class="badge badge-subject" id="modalQuestionSubject"></span>
            <span class="badge badge-topic" id="modalQuestionTopic"></span>
            <span class="badge badge-university" id="modalQuestionUniversity"></span>
          </div>
          <button class="modal-close" onclick="closeStudyModal()">&times;</button>
        </div>
    
        <div class="modal-body">
          <div class="question-content" id="modalQuestionText"></div>
    
          <!-- Opciones -->
          <div id="modalOptionsContainer"></div>
    
          <!-- Respuesta -->
          <div class="answer-section" id="modalAnswerSection" style="display:none;">
            <div id="modalAnswerText"></div>
            <div id="modalSolutionText" style="margin-top:10px;"></div>
          </div>
        </div>
    
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="showModalAnswer()">
            <i class="fas fa-eye"></i> Ver respuesta
          </button>
          <button class="btn btn-primary" onclick="getRandomQuestion()">
            <i class="fas fa-dice"></i> Nueva pregunta
          </button>
        </div>
      </div>
    </div>


    <!-- Modal de Carga Masiva (VERSI√ìN MEJORADA) -->
    <div class="modal-overlay" id="bulkModal" style="display: none;">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-import"></i> Carga Masiva de Preguntas
                </h3>
                <button class="modal-close" onclick="closeBulkModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Selectores de materia y tema -->
                <div class="form-group">
                    <label><i class="fas fa-book"></i> Materia para todas las preguntas</label>
                    <select class="form-control" id="bulkSubject">
                        <option value="Matem√°ticas">Matem√°ticas</option>
                        <option value="F√≠sica">F√≠sica</option>
                        <option value="Qu√≠mica">Qu√≠mica</option>
                        <option value="Biolog√≠a">Biolog√≠a</option>
                        <option value="Historia">Historia</option>
                        <option value="Geograf√≠a">Geograf√≠a</option>
                        <option value="Literatura">Literatura</option>
                        <option value="Ingl√©s">Ingl√©s</option>
                        <option value="_new_">‚úèÔ∏è Otra materia...</option>
                    </select>
                    
                    <input type="text" class="form-control" id="bulkNewSubject" 
                           placeholder="Escribe la nueva materia" style="margin-top: 8px; display: none;">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Tema para todas las preguntas</label>
                    <input type="text" class="form-control" id="bulkTopic" 
                           placeholder="Ej: √Ålgebra, C√°lculo, Geometr√≠a, Trigonometr√≠a">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-university"></i> Universidad</label>
                    <select class="form-control" id="bulkUniversity">
                        <option value="UNAM">UNAM</option>
                        <option value="IPN">IPN</option>
                        <option value="UAM">UAM</option>
                        <option value="TEC">TEC</option>
                        <option value="EXANI">EXANI</option>
                        <option value="NAVAL">NAVAL</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-info-circle"></i> Instrucciones</label>
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 10px; color: #333;">
                            <strong>Formato de texto:</strong> Cada pregunta debe estar separada por una l√≠nea en blanco
                        </p>
                        <div style="background: white; padding: 15px; border: 1px dashed #ccc; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
                            Calcula el √°rea del tri√°ngulo con base 10 y altura 5<br>
                            A) 25 cm¬≤<br>
                            B) 30 cm¬≤<br>
                            C) 35 cm¬≤<br>
                            D) 40 cm¬≤<br>
                            Respuesta: A<br>
                            <br>
                            Resuelve la ecuaci√≥n: 2x + 5 = 15<br>
                            A) x = 5<br>
                            B) x = 6<br>
                            C) x = 7<br>
                            D) x = 8<br>
                            Respuesta: A
                        </div>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                            <i class="fas fa-lightbulb"></i> <strong>Nota:</strong> Todas las preguntas se guardar√°n con la materia y tema seleccionados arriba.
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-paste"></i> Pega las preguntas</label>
                    <textarea 
                        id="bulkText" 
                        rows="12" 
                        placeholder="Pega aqu√≠ el contenido del libro o documento..."
                        style="width: 100%; font-family: monospace; font-size: 0.9rem;"
                    ></textarea>
                    
                    <div class="text-info" style="margin-top: 5px; font-size: 0.85rem;">
                        <i class="fas fa-chart-bar"></i> 
                        <span id="bulkStats">0 preguntas detectadas | 0 l√≠neas</span>
                    </div>
                </div>
                
                <!-- Vista previa (opcional) -->
                <div class="preview-container" id="bulkPreview" style="display: none; margin-top: 20px;">
                    <h5><i class="fas fa-search"></i> Vista previa (primera pregunta)</h5>
                    <div id="bulkPreviewContent" style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></div>
                </div>
                
                <div class="progress-container" id="bulkProgressContainer" style="display: none;">
                    <div class="progress-bar" id="bulkProgressBar"></div>
                    <div class="progress-text" id="bulkProgressText">0%</div>
                </div>
                
                <div class="result-container" id="bulkResultContainer" style="display: none;">
                    <div id="bulkResultMessage"></div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-primary" onclick="procesarCargaMasiva()" id="processBulkBtn">
                    <i class="fas fa-play"></i> Procesar Preguntas
                </button>
            </div>
        </div>
    </div>




    
    <!-- Modal para agregar/editar preguntas (MODAL MEJORADO) -->
    <div class="modal-overlay" id="questionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">
                    <i class="fas fa-plus-circle"></i> Nueva Pregunta
                </h3>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group modal-subject-group">
                    <label><i class="fas fa-book"></i> Materia</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="form-control" id="modalSubject" style="flex: 1;">
                            <option value="Matem√°ticas">Matem√°ticas</option>
                            <option value="F√≠sica">F√≠sica</option>
                            <option value="Qu√≠mica">Qu√≠mica</option>
                            <option value="Biolog√≠a">Biolog√≠a</option>
                            <option value="Historia">Historia</option>
                            <option value="Geograf√≠a">Geograf√≠a</option>
                        </select>
                        <input type="text" class="form-control" id="modalNewSubject" 
                               placeholder="Otra materia" style="flex: 1; display: none;">
                    </div>
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i> Selecciona una materia existente o escribe una nueva
                    </div>
                </div>
                                
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Tema</label>
                    <input type="text" class="form-control" id="modalTopic" 
                           placeholder="Ej: √Ålgebra, C√°lculo, Geometr√≠a">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-question-circle"></i> Pregunta</label>
                    
                    <!-- TECLADO MATEM√ÅTICO COMPLETO PARA PREGUNTA -->
                    <div class="math-toolbar" id="questionMathToolbar">
                        <div class="toolbar-section">
                            <span class="section-label">Operaciones:</span>
                            <button type="button" class="math-btn" data-symbol="\frac{ }{ }" title="Fracci√≥n" data-target="modalQuestion">
                                <i class="fas fa-divide"></i> Fracci√≥n
                            </button>
                            <button type="button" class="math-btn" data-symbol="\sqrt{ }" title="Ra√≠z cuadrada" data-target="modalQuestion">‚àö</button>
                            <button type="button" class="math-btn" data-symbol="\sqrt[n]{ }" title="Ra√≠z n-√©sima" data-target="modalQuestion">‚Åø‚àö</button>
                            <button type="button" class="math-btn" data-symbol="^{ }" title="Exponente" data-target="modalQuestion">x¬≤</button>
                               <button type="button" class="math-btn" data-symbol="_{ }" title="Sub√≠ndice" data-target="modalQuestion"> x‚ÇÇ </button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">Trig:</span>
                            <button type="button" class="math-btn" data-symbol="\sin(" title="Seno" data-target="modalQuestion">sin</button>
                            <button type="button" class="math-btn" data-symbol="\cos(" title="Coseno" data-target="modalQuestion">cos</button>
                            <button type="button" class="math-btn" data-symbol="\tan(" title="Tangente" data-target="modalQuestion">tan</button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">C√°lculo:</span>
                            <button type="button" class="math-btn" data-symbol="\lim_{ \to }" title="L√≠mite" data-target="modalQuestion">lim</button>
                            <button type="button" class="math-btn" data-symbol="\int_{ }^{ }" title="Integral" data-target="modalQuestion">‚à´</button>
                            <button type="button" class="math-btn" data-symbol="\sum_{ }^{ }" title="Sumatoria" data-target="modalQuestion">‚àë</button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">S√≠mbolos:</span>
                            <button type="button" class="math-btn" data-symbol="\infty" title="Infinito" data-target="modalQuestion">‚àû</button>
                            <button type="button" class="math-btn" data-symbol="\pi" title="Pi" data-target="modalQuestion">œÄ</button>
                            <button type="button" class="math-btn" data-symbol="\theta" title="Theta" data-target="modalQuestion">Œ∏</button>
                            <button type="button" class="math-btn" data-symbol="\alpha" title="Alpha" data-target="modalQuestion">Œ±</button>
                            <button type="button" class="math-btn" data-symbol="\beta" title="Beta" data-target="modalQuestion">Œ≤</button>
                            <button type="button" class="math-btn" data-symbol="\pm" title="M√°s menos" data-target="modalQuestion">¬±</button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">Estructuras:</span>
                            <button type="button" class="math-btn" data-symbol="( )" title="Par√©ntesis" data-target="modalQuestion">( )</button>
                            <button type="button" class="math-btn" data-symbol="[ ]" title="Corchetes" data-target="modalQuestion">[ ]</button>
                            <button type="button" class="math-btn" data-symbol="\{ \}" title="Llaves" data-target="modalQuestion">{ }</button>
                        </div>
                    </div>
                    
                    <textarea class="form-control" id="modalQuestion" 
                              placeholder="Escribe tu pregunta... (usa los botones arriba para s√≠mbolos)" 
                              rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-check-circle"></i> Respuesta</label>
                    
                    <!-- TECLADO MATEM√ÅTICO COMPLETO PARA RESPUESTA -->
                    <div class="math-toolbar" id="answerMathToolbar">
                        <div class="toolbar-section">
                            <span class="section-label">Operaciones:</span>
                            <button type="button" class="math-btn" data-symbol="\frac{ }{ }" title="Fracci√≥n" data-target="modalAnswer">
                                <i class="fas fa-divide"></i> Fracci√≥n
                            </button>
                            <button type="button" class="math-btn" data-symbol="\sqrt{ }" title="Ra√≠z cuadrada" data-target="modalAnswer">‚àö</button>
                            <button type="button" class="math-btn" data-symbol="\sqrt[n]{ }" title="Ra√≠z n-√©sima" data-target="modalAnswer">‚Åø‚àö</button>
                            <button type="button" class="math-btn" data-symbol="^{ }" title="Exponente" data-target="modalAnswer">x¬≤</button>
                            <button type="button" class="math-btn" data-symbol="=" title="Igual" data-target="modalAnswer">=</button>
                            <button type="button" class="math-btn" data-symbol="_{ }" title="Sub√≠ndice" data-target="modalQuestion"> x‚ÇÇ </button>

                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">S√≠mbolos:</span>
                            <button type="button" class="math-btn" data-symbol="\pi" title="Pi" data-target="modalAnswer">œÄ</button>
                            <button type="button" class="math-btn" data-symbol="\infty" title="Infinito" data-target="modalAnswer">‚àû</button>
                            <button type="button" class="math-btn" data-symbol="\pm" title="M√°s menos" data-target="modalAnswer">¬±</button>
                            <button type="button" class="math-btn" data-symbol="\neq" title="Diferente" data-target="modalAnswer">‚â†</button>
                            <button type="button" class="math-btn" data-symbol="\leq" title="Menor o igual" data-target="modalAnswer">‚â§</button>
                            <button type="button" class="math-btn" data-symbol="\geq" title="Mayor o igual" data-target="modalAnswer">‚â•</button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">Estructuras:</span>
                            <button type="button" class="math-btn" data-symbol="( )" title="Par√©ntesis" data-target="modalAnswer">( )</button>
                            <button type="button" class="math-btn" data-symbol="[ ]" title="Corchetes" data-target="modalAnswer">[ ]</button>
                            <button type="button" class="math-btn" data-symbol="\{ \}" title="Llaves" data-target="modalAnswer">{ }</button>
                        </div>
                    </div>
                    
                    <!-- Checkbox para opciones m√∫ltiples -->
                    <div style="margin: 12px 0 8px 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                            <input type="checkbox" id="hasOptionsCheckbox" onchange="toggleOptions()">
                            <span><i class="fas fa-list-ol"></i> Es una pregunta de opci√≥n m√∫ltiple (4 opciones)</span>
                        </label>
                    </div>
                    
                    <!-- RESPUESTA ABIERTA (por defecto) -->
                    <div id="openAnswerSection">
                        <textarea class="form-control" id="modalAnswer" 
                                  placeholder="Escribe la respuesta... (usa los botones arriba para s√≠mbolos)" 
                                  rows="3"></textarea>
                    </div>
                    
                    <!-- SECCI√ìN DE OPCIONES (oculta por defecto) -->
                    <div id="optionsSection" style="display: none;">
                        <h4><i class="fas fa-check-circle"></i> Opciones de Respuesta (selecciona la correcta)</h4>
                        
                        <div class="options-grid">
                            <!-- Opci√≥n A -->
                            <div class="option-group">
                                <label style="color: #ef4444;"><i class="fas fa-circle"></i> Opci√≥n A</label>
                                <textarea class="form-control option-input" id="optionA" 
                                          placeholder="Texto de la opci√≥n A" rows="2"
                                          onfocus="handleOptionFocus(event)"></textarea>
                                <div style="margin-top: 6px;">
                                    <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem;">
                                        <input type="radio" name="correctOption" value="0" id="correctOptionA">
                                        <span>Es la correcta</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Opci√≥n B -->
                            <div class="option-group">
                                <label style="color: #3b82f6;"><i class="fas fa-circle"></i> Opci√≥n B</label>
                                <textarea class="form-control option-input" id="optionB" 
                                            placeholder="Texto de la opci√≥n B" rows="2"
                                            onfocus="handleOptionFocus(event)"></textarea>
                                <div style="margin-top: 6px;">
                                    <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem;">
                                        <input type="radio" name="correctOption" value="1" id="correctOptionB">
                                        <span>Es la correcta</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Opci√≥n C -->
                            <div class="option-group">
                                <label style="color: #22c55e;"><i class="fas fa-circle"></i> Opci√≥n C</label>
                                <textarea class="form-control option-input" id="optionC" 
                                          placeholder="Texto de la opci√≥n C" rows="2"
                                           onfocus="handleOptionFocus(event)"></textarea>
                                <div style="margin-top: 6px;">
                                    <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem;">
                                        <input type="radio" name="correctOption" value="2" id="correctOptionC">
                                        <span>Es la correcta</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Opci√≥n D -->
                            <div class="option-group">
                                <label style="color: #f59e0b;"><i class="fas fa-circle"></i> Opci√≥n D</label>
                                <textarea class="form-control option-input" id="optionD" 
                                          placeholder="Texto de la opci√≥n D" rows="2"
                                           onfocus="handleOptionFocus(event)"></textarea>
                                <div style="margin-top: 6px;">
                                    <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.8rem;">
                                        <input type="radio" name="correctOption" value="3" id="correctOptionD">
                                        <span>Es la correcta</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-hint" style="margin-top: 12px;">
                            <i class="fas fa-info-circle"></i> Marca con el bot√≥n de radio cu√°l es la opci√≥n correcta
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-list-ol"></i> Soluci√≥n Detallada (Opcional)</label>
                    
                    <!-- TECLADO MATEM√ÅTICO COMPLETO PARA SOLUCI√ìN -->
                    <div class="math-toolbar" id="solutionMathToolbar">
                        <div class="toolbar-section">
                            <span class="section-label">Operaciones:</span>
                            <button type="button" class="math-btn" data-symbol="\frac{ }{ }" title="Fracci√≥n" data-target="modalSolution">
                                <i class="fas fa-divide"></i> Fracci√≥n
                            </button>
                            <button type="button" class="math-btn" data-symbol="\sqrt{ }" title="Ra√≠z cuadrada" data-target="modalSolution">‚àö</button>
                            <button type="button" class="math-btn" data-symbol="\sqrt[n]{ }" title="Ra√≠z n-√©sima" data-target="modalSolution">‚Åø‚àö</button>
                            <button type="button" class="math-btn" data-symbol="^{ }" title="Exponente" data-target="modalSolution">x¬≤</button>
                            <button type="button" class="math-btn" data-symbol="=" title="Igual" data-target="modalSolution">=</button>
                            <button type="button" class="math-btn" data-symbol="\Rightarrow" title="Implica" data-target="modalSolution">‚áí</button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">C√°lculo:</span>
                            <button type="button" class="math-btn" data-symbol="\int_{ }^{ }" title="Integral" data-target="modalSolution">‚à´</button>
                            <button type="button" class="math-btn" data-symbol="\frac{d}{dx}" title="Derivada" data-target="modalSolution">d/dx</button>
                            <button type="button" class="math-btn" data-symbol="\lim_{ \to }" title="L√≠mite" data-target="modalSolution">lim</button>
                            <button type="button" class="math-btn" data-symbol="\sum_{ }^{ }" title="Sumatoria" data-target="modalSolution">‚àë</button>
                        </div>
                        
                        <div class="toolbar-section">
                            <span class="section-label">S√≠mbolos:</span>
                            <button type="button" class="math-btn" data-symbol="\pi" title="Pi" data-target="modalSolution">œÄ</button>
                            <button type="button" class="math-btn" data-symbol="\theta" title="Theta" data-target="modalSolution">Œ∏</button>
                            <button type="button" class="math-btn" data-symbol="\alpha" title="Alpha" data-target="modalSolution">Œ±</button>
                            <button type="button" class="math-btn" data-symbol="\beta" title="Beta" data-target="modalSolution">Œ≤</button>
                            <button type="button" class="math-btn" data-symbol="\pm" title="M√°s menos" data-target="modalSolution">¬±</button>
                        </div>
                    </div>
                    
                    <textarea class="form-control" id="modalSolution" 
                              placeholder="Explica los pasos para llegar a la respuesta..." 
                              rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-university"></i> Universidad</label>
                    <select class="form-control" id="modalUniversity">
                        <option value="UNAM">UNAM</option>
                        <option value="IPN">IPN</option>
                        <option value="UAM">UAM</option>
                        <option value="TEC">TEC</option>
                        <option value="EXANI">EXANI</option>
                        <option value="NAVAL">NAVAL</option>
                        <option value="_new_">‚úèÔ∏è Otra universidad...</option>
                    </select>
                
                    <input
                        type="text"
                        class="form-control"
                        id="modalNewUniversity"
                        placeholder="Escribe la universidad"
                        style="margin-top: 8px; display: none;"
                    />
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelModalBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveQuestionBtn">
                    <i class="fas fa-save"></i> Guardar Pregunta
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmaci√≥n para eliminar -->
    <div class="modal-overlay" id="confirmModal" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci√≥n
                </h3>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√°s seguro de que quieres eliminar esta pregunta?</p>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 10px;">
                    Esta acci√≥n no se puede deshacer.
                </p>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de ayuda -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-question-circle"></i> Ayuda para Maestros</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">üìö Panel de Maestro</h4>
                <ul style="margin: 0 0 20px 20px; line-height: 1.7; color: var(--text-secondary); font-size: 0.9rem;">
                    <li><strong>Banco de Preguntas:</strong> Ver, editar y eliminar todas las preguntas del sistema</li>
                    <li><strong>Estad√≠sticas:</strong> Ver an√°lisis detallados del uso del sistema</li>
                    <li><strong>Modo Estudio:</strong> Probar las preguntas como lo har√≠a un alumno</li>
                    <li><strong>Nueva Pregunta:</strong> Agregar preguntas nuevas con f√≥rmulas matem√°ticas</li>
                </ul>
                
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">üìù Crear Preguntas</h4>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    Puedes crear dos tipos de preguntas:
                </p>
                <ul style="margin: 8px 0 20px 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    <li><strong>Respuesta abierta:</strong> El alumno debe pensar la respuesta</li>
                    <li><strong>Opci√≥n m√∫ltiple:</strong> Con 4 opciones, solo una correcta</li>
                </ul>
                
                <h4 style="margin-bottom: 12px; color: var(--text-primary);">üìä Estad√≠sticas</h4>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    Como maestro puedes ver:
                </p>
                <ul style="margin: 8px 0 0 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    <li>Distribuci√≥n de preguntas por materia y universidad</li>
                    <li>Temas m√°s populares entre los alumnos</li>
                    <li>Rendimiento general del sistema</li>
                    <li>Preguntas m√°s visitadas</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary">Entendido</button>
            </div>
        </div>
    </div>
    
    <!-- Notificaci√≥n -->
    <div class="notification" id="notification"></div>
    
    
    <!-- JavaScript para el panel de maestro -->
    <script>
        let currentUser = null;
        let userRole = null;
        let allQuestions = [];
        let currentPage = 1;
        let itemsPerPage = 12;
        let currentSearch = '';
        let currentFilters = {
            subject: 'todos',
            topic: 'todos',
            university: 'todos',
            type: 'todos'
        };
        let questionToDelete = null;
        let isEditMode = false;
        let currentEditQuestionId = null;
        let studySelectedSubject = 'todos';
        let studySelectedTopic = 'todos';
        
        // Verificar autenticaci√≥n y rol
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            
            if (currentUser && userRole === 'maestro') {
                setupUserInterface();
                initMaestroApp();
                loadAllData();
            } else {
                // Redirigir a login si no es maestro
                window.location.href = '/login';
            }
        });
        
        async function checkAuthentication() {
            try {
                const response = await fetch('/api/current-user');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    userRole = data.user.rol;
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                return false;
            }
        }
        
        function setupUserInterface() {
            // Actualizar informaci√≥n del usuario
            document.getElementById('userGreeting').textContent = `Panel de Maestro`;
            document.getElementById('userName').textContent = `${currentUser.nombre} ${currentUser.apellido}`;
            
            // Configurar eventos del men√∫
            document.querySelectorAll('.menu-item[data-page]').forEach(item => {
                item.addEventListener('click', function() {
                    if (this.id === 'openModalBtn') {
                        openModal();
                        return;
                    }
                    
                    // Remover active de todos
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    
                    // Activar el seleccionado
                    this.classList.add('active');
                    const pageId = this.dataset.page + 'Page';
                    document.getElementById(pageId).classList.add('active');
                    
                    // Cargar datos espec√≠ficos de cada p√°gina
                    if (this.dataset.page === 'questions') {
                        loadQuestionsPage();
                    } else if (this.dataset.page === 'stats') {
                        loadStatsPage();
                    } else if (this.dataset.page === 'study') {
                        loadStudyPage();
                    }
                });
            });
            
            // Bot√≥n de logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Botones flotantes y de modal
            // Y c√°mbialas para usar window.openModal (la funci√≥n de app.js):
            document.getElementById('openModalBtn').addEventListener('click', function() {
                window.openModal();
            });
            document.getElementById('openModalFromListBtn').addEventListener('click', function() {
                window.openModal();
            });
            document.getElementById('floatingNewQuestionBtn').addEventListener('click', function() {
                window.openModal();
            });
            document.getElementById('addFirstQuestionBtn').addEventListener('click', function() {
                window.openModal();
            });
            // Bot√≥n de ayuda
            document.getElementById('showHelpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.add('active');
            });
            
            // Cerrar modales
            document.querySelectorAll('#helpModal .modal-close, #helpModal .btn-primary').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('helpModal').classList.remove('active');
                });
            });
        }
        
        function initMaestroApp() {
            // Modal de preguntas - Eventos de cierre
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                window.closeModal(); // Usar la funci√≥n de app.js
            });
            document.getElementById('cancelModalBtn').addEventListener('click', function() {
                window.closeModal(); // Usar la funci√≥n de app.js
            });
            document.getElementById('saveQuestionBtn').addEventListener('click', saveQuestion);
            
            // Teclados matem√°ticos - Inicializar
            initMathToolbars();
            
            // Filtros
            document.getElementById('subjectFilter').addEventListener('change', function() {
                updateTopicFilter();
                applyFilters();
            });
            document.getElementById('topicFilter').addEventListener('change', applyFilters);
            document.getElementById('universityFilter').addEventListener('change', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            // B√∫squeda
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
            
            // Paginaci√≥n
            document.getElementById('prevPageBtn').addEventListener('click', prevPage);
            document.getElementById('nextPageBtn').addEventListener('click', nextPage);
            
            // Modo estudio
            document.getElementById('getQuestionBtn').addEventListener('click', getRandomQuestion);
            
            // Universidad personalizada en modal
            const modalUniversitySelect = document.getElementById('modalUniversity');
            const modalNewUniversityInput = document.getElementById('modalNewUniversity');
            
            modalUniversitySelect.addEventListener('change', function() {
                if (this.value === '_new_') {
                    modalNewUniversityInput.style.display = 'block';
                    modalNewUniversityInput.focus();
                } else {
                    modalNewUniversityInput.style.display = 'none';
                }
            });
            
            // Checkbox para opciones m√∫ltiples
            const hasOptionsCheckbox = document.getElementById('hasOptionsCheckbox');
            if (hasOptionsCheckbox) {
                hasOptionsCheckbox.addEventListener('change', toggleOptions);
            }
            
            // Configurar bot√≥n de eliminar en modal de confirmaci√≥n
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteQuestion);
        }
        
        function initMathToolbars() {
            // Inicializar todos los teclados matem√°ticos
            ['questionMathToolbar', 'answerMathToolbar', 'solutionMathToolbar'].forEach(toolbarId => {
                const toolbar = document.getElementById(toolbarId);
                if (toolbar) {
                    toolbar.addEventListener('click', function(e) {
                        if (e.target.classList.contains('math-btn')) {
                            const symbol = e.target.dataset.symbol;
                            const targetId = e.target.dataset.target;
                            const textarea = document.getElementById(targetId);
                            
                            if (textarea) {
                                insertSymbolAtCursor(textarea, symbol);
                                textarea.focus();
                            }
                        }
                    });
                }
            });
            
            // Para las opciones m√∫ltiples
            document.querySelectorAll('.option-input').forEach(textarea => {
                // Los botones matem√°ticos para opciones se manejan mediante el evento focus
            });
        }
        
        function insertSymbolAtCursor(textarea, symbol) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            // Insertar el s√≠mbolo en la posici√≥n del cursor
            textarea.value = text.substring(0, start) + symbol + text.substring(end);
            
            // Reposicionar el cursor despu√©s del s√≠mbolo insertado
            const newPosition = start + symbol.length;
            textarea.selectionStart = newPosition;
            textarea.selectionEnd = newPosition;
            
            // Disparar evento de cambio para actualizar MathJax si es necesario
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        function handleOptionFocus(event) {
            const textarea = event.target;
            const optionId = textarea.id;
            
            // Determinar qu√© toolbar matem√°tico usar
            const toolbar = document.getElementById('answerMathToolbar');
            
            // Actualizar todos los botones para que apunten a esta textarea
            if (toolbar) {
                toolbar.querySelectorAll('.math-btn').forEach(btn => {
                    btn.dataset.target = optionId;
                });
            }
        }
        
        function toggleOptions() {
            const hasOptions = document.getElementById('hasOptionsCheckbox').checked;
            const optionsSection = document.getElementById('optionsSection');
            const openAnswerSection = document.getElementById('openAnswerSection');
            
            if (hasOptions) {
                optionsSection.style.display = 'block';
                openAnswerSection.style.display = 'none';
            } else {
                optionsSection.style.display = 'none';
                openAnswerSection.style.display = 'block';
            }
        }
        
        async function loadAllData() {
            try {
                // Cargar preguntas
                const response = await fetch('/api/questions');
                const data = await response.json();
                
                if (data.success) {
                    allQuestions = data.questions;
                    updateSidebarStats();
                    updateFilterOptions();
                    loadQuestionsPage();
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                showNotification('Error al cargar los datos', 'error');
            }
        }
        
        function updateSidebarStats() {
            const total = allQuestions.length;
            const subjects = [...new Set(allQuestions.map(q => q.subject))].length;
            const shown = allQuestions.reduce((sum, q) => sum + (q.times_shown || 0), 0);
            const correct = allQuestions.reduce((sum, q) => sum + (q.times_correct || 0), 0);
            
            document.getElementById('sidebarTotal').textContent = total;
            document.getElementById('sidebarSubjects').textContent = subjects;
            document.getElementById('sidebarShown').textContent = shown;
            
            // Actualizar resumen estad√≠stico
            document.getElementById('totalQuestionsStat').textContent = total;
            document.getElementById('totalSubjectsStat').textContent = subjects;
            document.getElementById('totalShownStat').textContent = shown;
            document.getElementById('totalCorrectStat').textContent = correct;
        }
        
        function updateFilterOptions() {
            const subjectSelect = document.getElementById('subjectFilter');
            subjectSelect.innerHTML = '<option value="todos">Todas las materias</option>';
            
            const subjects = [...new Set(allQuestions.map(q => q.subject))].sort();
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }
        
        async function updateTopicFilter() {
            const subject = document.getElementById('subjectFilter').value;
            const topicFilter = document.getElementById('topicFilter');
            
            // Guardar selecci√≥n actual
            const currentTopic = topicFilter.value;
            
            // Limpiar opciones excepto la primera
            topicFilter.innerHTML = '<option value="todos">Todos los temas</option>';
            
            if (subject !== 'todos') {
                // Obtener temas √∫nicos de la materia seleccionada
                const topics = [...new Set(
                    allQuestions
                        .filter(q => q.subject === subject)
                        .map(q => q.topic)
                )].sort();
                
                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    topicFilter.appendChild(option);
                });
                
                // Restaurar selecci√≥n si a√∫n existe
                if (topics.includes(currentTopic)) {
                    topicFilter.value = currentTopic;
                }
            }
        }
        
        function applyFilters() {
            currentFilters = {
                subject: document.getElementById('subjectFilter').value,
                topic: document.getElementById('topicFilter').value,
                university: document.getElementById('universityFilter').value,
                type: document.getElementById('typeFilter').value
            };
            
            currentPage = 1;
            displayQuestions();
        }
        
        function performSearch() {
            currentSearch = document.getElementById('searchInput').value.trim().toLowerCase();
            currentPage = 1;
            displayQuestions();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            displayQuestions();
        }
        
        function clearFilters() {
            document.getElementById('subjectFilter').value = 'todos';
            document.getElementById('topicFilter').value = 'todos';
            document.getElementById('universityFilter').value = 'todos';
            document.getElementById('typeFilter').value = 'todos';
            document.getElementById('searchInput').value = '';
            
            currentFilters = {
                subject: 'todos',
                topic: 'todos',
                university: 'todos',
                type: 'todos'
            };
            currentSearch = '';
            currentPage = 1;
            
            displayQuestions();
        }
        
        function displayQuestions() {
            // Filtrar preguntas
            let filteredQuestions = allQuestions.filter(question => {
                // Filtrar por materia
                if (currentFilters.subject !== 'todos' && question.subject !== currentFilters.subject) {
                    return false;
                }
                
                // Filtrar por tema
                if (currentFilters.topic !== 'todos' && question.topic !== currentFilters.topic) {
                    return false;
                }
                
                // Filtrar por universidad
                if (currentFilters.university !== 'todos' && question.university !== currentFilters.university) {
                    return false;
                }
                
                // Filtrar por tipo
                if (currentFilters.type !== 'todos') {
                    if (currentFilters.type === 'opciones' && !question.has_options) {
                        return false;
                    }
                    if (currentFilters.type === 'abierta' && question.has_options) {
                        return false;
                    }
                }
                
                // Filtrar por b√∫squeda
                if (currentSearch) {
                    const searchText = currentSearch.toLowerCase();
                    const questionText = question.question.toLowerCase();
                    const answerText = (question.answer || question.correct_answer || '').toLowerCase();
                    const solutionText = (question.solution || '').toLowerCase();
                    
                    if (!questionText.includes(searchText) && 
                        !answerText.includes(searchText) && 
                        !solutionText.includes(searchText)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Actualizar contadores
            updateSidebarStats();
            
            // Mostrar/ocultar estados vac√≠os
            const container = document.getElementById('questionsList');
            const noQuestionsMsg = document.getElementById('noQuestionsMessage');
            const noSearchResults = document.getElementById('noSearchResults');
            const pagination = document.getElementById('pagination');
            
            if (filteredQuestions.length === 0) {
                container.style.display = 'none';
                pagination.style.display = 'none';
                
                if (currentSearch || 
                    currentFilters.subject !== 'todos' || 
                    currentFilters.topic !== 'todos' || 
                    currentFilters.university !== 'todos' || 
                    currentFilters.type !== 'todos') {
                    noSearchResults.style.display = 'block';
                    noQuestionsMsg.style.display = 'none';
                } else {
                    noQuestionsMsg.style.display = 'block';
                    noSearchResults.style.display = 'none';
                }
                return;
            }
            
            container.style.display = 'grid';
            noQuestionsMsg.style.display = 'none';
            noSearchResults.style.display = 'none';
            
            // Calcular paginaci√≥n
            const totalPages = Math.ceil(filteredQuestions.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageQuestions = filteredQuestions.slice(startIndex, endIndex);
            
            // Mostrar preguntas
            container.innerHTML = '';
            pageQuestions.forEach(question => {
                const questionCard = createQuestionCard(question);
                container.appendChild(questionCard);
            });
            
            // Actualizar MathJax
            if (window.MathJax) {
                MathJax.typesetPromise()
                    .catch(err => console.log('MathJax error:', err));
            }
            
            // Actualizar paginaci√≥n
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
                document.getElementById('pageInfo').textContent = 
                    `P√°gina ${currentPage} de ${totalPages} (${filteredQuestions.length} preguntas)`;
            } else {
                pagination.style.display = 'none';
            }
        }
        
        function createQuestionCard(question) {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            // Truncar texto largo
            const questionText = question.question.length > 200 ? 
                question.question.substring(0, 200) + '...' : question.question;
            
            const isLong = question.question.length > 200;
            
            card.innerHTML = `
                <div class="question-header">
                    <div class="question-badges">
                        <span class="badge badge-subject">${question.subject}</span>
                        <span class="badge badge-topic">${question.topic}</span>
                        <span class="badge badge-university">${question.university || 'N/A'}</span>
                        ${question.has_options ? 
                            '<span style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem;">Opciones</span>' : 
                            '<span style="background: rgba(16, 185, 129, 0.15); color: var(--primary); padding: 3px 8px; border-radius: 12px; font-size: 0.7rem;">Abierta</span>'}
                    </div>
                </div>
                
                <div class="question-content ${isLong ? '' : 'expanded'}">
                    ${questionText}
                    ${isLong ? '<span class="read-more" onclick="toggleQuestionText(this)">[leer m√°s]</span>' : ''}
                </div>
                
                <div class="question-actions">
                    <button class="btn btn-warning btn-sm" onclick="editQuestion('${question._id}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="confirmDelete('${question._id}')">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="previewQuestion('${question._id}')">
                        <i class="fas fa-eye"></i> Vista previa
                    </button>
                </div>
                
                <div class="question-stats">
                    <span><i class="fas fa-eye"></i> ${question.times_shown || 0} vistas</span>
                    <span><i class="fas fa-check-circle"></i> ${question.times_correct || 0} correctas</span>
                    <span><i class="fas fa-calendar"></i> ${formatDate(question.created_at)}</span>
                </div>
            `;
            
            return card;
        }
        
        function toggleQuestionText(element) {
            const content = element.closest('.question-content');
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.classList.remove('expanded');
                element.textContent = '[leer m√°s]';
            } else {
                content.classList.add('expanded');
                element.textContent = '[leer menos]';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayQuestions();
            }
        }
        
        function nextPage() {
            const totalQuestions = getFilteredQuestions().length;
            const totalPages = Math.ceil(totalQuestions / itemsPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                displayQuestions();
            }
        }
        
        function getFilteredQuestions() {
            return allQuestions.filter(question => {
                // Aplicar los mismos filtros que en displayQuestions
                if (currentFilters.subject !== 'todos' && question.subject !== currentFilters.subject) {
                    return false;
                }
                if (currentFilters.topic !== 'todos' && question.topic !== currentFilters.topic) {
                    return false;
                }
                if (currentFilters.university !== 'todos' && question.university !== currentFilters.university) {
                    return false;
                }
                if (currentFilters.type !== 'todos') {
                    if (currentFilters.type === 'opciones' && !question.has_options) return false;
                    if (currentFilters.type === 'abierta' && question.has_options) return false;
                }
                if (currentSearch) {
                    const searchText = currentSearch.toLowerCase();
                    const questionText = question.question.toLowerCase();
                    const answerText = (question.answer || question.correct_answer || '').toLowerCase();
                    
                    if (!questionText.includes(searchText) && !answerText.includes(searchText)) {
                        return false;
                    }
                }
                return true;
            });
        }
        
        function loadQuestionsPage() {
            displayQuestions();
        }
        
        async function loadStatsPage() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // Distribuci√≥n por materias
                    const subjectsChart = document.getElementById('subjectsChart');
                    subjectsChart.innerHTML = createBarChart(stats.subjects, 'subject');
                    
                    // Distribuci√≥n por universidad
                    const universitiesChart = document.getElementById('universitiesChart');
                    universitiesChart.innerHTML = createBarChart(stats.universities, 'university');
                    
                    // Temas populares
                    const topicsList = document.getElementById('topTopicsList');
                    topicsList.innerHTML = createTopicsList(stats.top_topics);
                    
                    // Rendimiento
                    const performanceStats = document.getElementById('performanceStats');
                    performanceStats.innerHTML = createPerformanceStats(stats);
                    
                    // Preguntas m√°s vistas
                    const mostViewed = document.getElementById('mostViewedQuestions');
                    mostViewed.innerHTML = createMostViewedList(allQuestions);
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                showNotification('Error al cargar estad√≠sticas', 'error');
            }
        }
        
        function createBarChart(data, type) {
            if (!data || data.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted);">No hay datos disponibles</p>';
            }
            
            const maxCount = Math.max(...data.map(item => item.count));
            let html = '';
            
            data.forEach(item => {
                const percentage = maxCount > 0 ? (item.count / maxCount * 100) : 0;
                const color = type === 'subject' ? 'var(--primary)' : 'var(--accent)';
                
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 600;">${item._id}</span>
                            <span>${item.count}</span>
                        </div>
                        <div style="height: 10px; background: var(--bg-elevated); border-radius: 5px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function createTopicsList(topics) {
            if (!topics || topics.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted);">No hay temas disponibles</p>';
            }
            
            let html = '';
            topics.forEach((topic, index) => {
                html += `
                    <div style="margin-bottom: 10px; padding: 10px; background: var(--bg-elevated); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 700; color: var(--text-primary);">#${index + 1}</span>
                                <span style="margin-left: 10px; font-weight: 600;">${topic._id}</span>
                            </div>
                            <span style="color: var(--primary); font-weight: bold;">${topic.count}</span>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function createPerformanceStats(stats) {
            const totalShown = stats.total_shown || 0;
            const totalCorrect = allQuestions.reduce((sum, q) => sum + (q.times_correct || 0), 0);
            const accuracy = totalShown > 0 ? ((totalCorrect / totalShown) * 100).toFixed(1) : 0;
            
            return `
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--success); margin-bottom: 10px;">
                        ${accuracy}%
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                        Precisi√≥n global
                    </div>
                    <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">${totalShown}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Total respuestas</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${totalCorrect}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Correctas</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createMostViewedList(questions) {
            // Ordenar por veces mostradas
            const sortedQuestions = [...questions]
                .sort((a, b) => (b.times_shown || 0) - (a.times_shown || 0))
                .slice(0, 5);
            
            if (sortedQuestions.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted);">No hay preguntas vistas</p>';
            }
            
            let html = '';
            sortedQuestions.forEach((question, index) => {
                const preview = question.question.length > 50 ? 
                    question.question.substring(0, 50) + '...' : question.question;
                
                html += `
                    <div style="margin-bottom: 15px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <span style="font-weight: 700; color: var(--text-primary);">#${index + 1}</span>
                                    <span style="font-size: 0.8rem; background: rgba(16, 185, 129, 0.15); color: var(--primary); padding: 2px 8px; border-radius: 12px;">
                                        ${question.subject}
                                    </span>
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 5px;">
                                    ${preview}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">
                                    ${question.times_shown || 0}
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">veces vista</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function loadStudyPage() {
            loadStudySubjects();
        }
        
        async function loadStudySubjects() {
            const container = document.getElementById('subjectButtons');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Agregar "Todas las materias"
            const allBtn = document.createElement('div');
            allBtn.className = 'subject-btn active';
            allBtn.innerHTML = `
                <i class="fas fa-layer-group"></i> Todas las materias
                <span class="count">${allQuestions.length}</span>
            `;
            allBtn.dataset.subject = 'todos';
            allBtn.addEventListener('click', function() {
                document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                studySelectedSubject = 'todos';
                studySelectedTopic = 'todos';
                loadStudyTopics();
            });
            container.appendChild(allBtn);
            
            // Agregar cada materia
            const subjects = [...new Set(allQuestions.map(q => q.subject))];
            subjects.forEach(subject => {
                const count = allQuestions.filter(q => q.subject === subject).length;
                if (count === 0) return;
                
                const btn = document.createElement('div');
                btn.className = 'subject-btn';
                btn.innerHTML = `
                    <i class="fas fa-book"></i> ${subject}
                    <span class="count">${count}</span>
                `;
                btn.dataset.subject = subject;
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    studySelectedSubject = subject;
                    studySelectedTopic = 'todos';
                    loadStudyTopics();
                });
                container.appendChild(btn);
            });
        }
        
        async function loadStudyTopics() {
            const container = document.getElementById('studyTopicButtons');
            const topicSelector = document.getElementById('topicSelectorContainer');
            
            if (!studySelectedSubject || studySelectedSubject === 'todos') {
                topicSelector.style.display = 'none';
                return;
            }
            
            try {
                container.innerHTML = '';
                topicSelector.style.display = 'block';
                
                const response = await fetch(`/api/subjects/${encodeURIComponent(studySelectedSubject)}/topics`);
                const data = await response.json();
                
                if (data.success && data.topics.length > 0) {
                    document.getElementById('currentSubjectName').textContent = studySelectedSubject;
                    
                    // Agregar "Todos los temas"
                    const allBtn = document.createElement('div');
                    allBtn.className = studySelectedTopic === 'todos' ? 'topic-btn-with-action all-topics active' : 'topic-btn-with-action all-topics';
                    allBtn.innerHTML = `
                        <div class="topic-btn-content">
                            <i class="fas fa-layer-group"></i> Todos los temas
                        </div>
                    `;
                    allBtn.dataset.topic = 'todos';
                    allBtn.addEventListener('click', function() {
                        document.querySelectorAll('.topic-btn-with-action').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        studySelectedTopic = 'todos';
                    });
                    container.appendChild(allBtn);
                    
                    // Agregar cada tema
                    data.topics.forEach(topic => {
                        const btn = document.createElement('div');
                        btn.className = studySelectedTopic === topic ? 'topic-btn-with-action active' : 'topic-btn-with-action';
                        btn.innerHTML = `
                            <div class="topic-btn-content">
                                <i class="fas fa-folder"></i> ${topic}
                            </div>
                        `;
                        btn.dataset.topic = topic;
                        btn.addEventListener('click', function() {
                            document.querySelectorAll('.topic-btn-with-action').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            studySelectedTopic = topic;
                        });
                        container.appendChild(btn);
                    });
                }
            } catch (error) {
                console.error('Error cargando temas:', error);
                topicSelector.style.display = 'none';
            }
        }
        
        async function getRandomQuestion() {
            if (!studySelectedSubject) {
                showNotification('Primero selecciona una materia', 'warning');
                return;
            }
            
            let url = `/api/questions/random`;
            const params = [];
            
            if (studySelectedSubject !== 'todos') {
                params.push(`subject=${encodeURIComponent(studySelectedSubject)}`);
            }
            
            if (studySelectedTopic !== 'todos') {
                params.push(`topic=${encodeURIComponent(studySelectedTopic)}`);
            }
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            const getBtn = document.getElementById('getQuestionBtn');
            const originalText = getBtn.innerHTML;
            getBtn.innerHTML = '<i class="fas fa-spinner loading"></i> Buscando...';
            getBtn.disabled = true;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displayStudyQuestion(data.question);
                } else {
                    showNotification('No hay preguntas con estos filtros', 'warning');
                }
            } catch (error) {
                console.error('Error obteniendo pregunta:', error);
                showNotification('Error de conexi√≥n', 'error');
            } finally {
                getBtn.innerHTML = originalText;
                getBtn.disabled = false;
            }
        }
        
        function displayStudyQuestion(question) {
            document.getElementById('modalQuestionSubject').textContent = question.subject;
            document.getElementById('modalQuestionTopic').textContent = question.topic;
            document.getElementById('modalQuestionUniversity').textContent = question.university;
            document.getElementById('modalQuestionText').innerHTML = question.question;
            
            const optionsContainer = document.getElementById('modalOptionsContainer');
            optionsContainer.innerHTML = '';
            
            if (question.has_options && question.options && question.options.length > 0) {
                let optionsHTML = '';
                
                question.options.forEach((option, index) => {
                    const letter = String.fromCharCode(65 + index);
                    optionsHTML += `
                        <div class="option-card" onclick="checkAnswer(${index}, '${question._id}')" data-index="${index}">
                            <div class="option-letter-circle">${letter}</div>
                            <div class="option-content">${option}</div>
                        </div>
                    `;
                });
                
                optionsContainer.innerHTML = optionsHTML;
            }
            
            document.getElementById('modalAnswerText').innerHTML = question.answer || question.correct_answer || '';
            document.getElementById('modalSolutionText').innerHTML = question.solution || '';
            document.getElementById('modalAnswerSection').style.display = 'none';
            
            document.getElementById('studyQuestionModal').style.display = 'flex';
            
            if (window.MathJax) {
                MathJax.typesetPromise()
                    .catch(err => console.log('MathJax error:', err));
            }
        }
        
        function previewQuestion(questionId) {
            const question = allQuestions.find(q => q._id === questionId);
            if (question) {
                displayStudyQuestion(question);
            }
        }
        
        function checkAnswer(selectedIndex, questionId) {
            const question = allQuestions.find(q => q._id === questionId);
            if (!question || !question.has_options) return;
            
            const optionCards = document.querySelectorAll('#modalOptionsContainer .option-card');
            const isCorrect = selectedIndex === question.correct_option;
            
            optionCards.forEach(card => {
                card.style.cursor = 'not-allowed';
                card.onclick = null;
            });
            
            const selectedCard = optionCards[selectedIndex];
            if (selectedCard) {
                if (isCorrect) {
                    selectedCard.classList.add('correct');
                    showNotification('‚úÖ ¬°Respuesta correcta!', 'success');
                } else {
                    selectedCard.classList.add('incorrect');
                    showNotification('‚ùå Respuesta incorrecta', 'error');
                }
            }
            
            if (!isCorrect && question.correct_option >= 0) {
                const correctCard = optionCards[question.correct_option];
                if (correctCard) {
                    correctCard.classList.add('correct');
                }
            }
            
            if (question.solution && question.solution.trim() !== '') {
                document.getElementById('modalSolutionText').innerHTML = 
                    `<div class="solution-box">
                        <h4><i class="fas fa-list-ol"></i> Soluci√≥n Detallada</h4>
                        <div>${question.solution}</div>
                    </div>`;
            }
        }
        
        function closeStudyModal() {
            document.getElementById('studyQuestionModal').style.display = 'none';
        }
        
        function showModalAnswer() {
            document.getElementById('modalAnswerSection').style.display = 'block';
            if (window.MathJax) {
                MathJax.typesetPromise()
                    .catch(err => console.log('MathJax error:', err));
            }
        }
        
        // Funciones para el modal de preguntas
        function openModal(questionId = null) {
            if (questionId) {
                editQuestion(questionId);
            } else {
                resetModal();
                document.getElementById('questionModal').classList.add('active');
            }
        }
        
        function closeModal() {
            document.getElementById('questionModal').classList.remove('active');
            resetModal();
        }
        
        function resetModal() {
            isEditMode = false;
            currentEditQuestionId = null;
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Nueva Pregunta';
            document.getElementById('saveQuestionBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Pregunta';
            
            document.getElementById('modalSubject').value = 'Matem√°ticas';
            document.getElementById('modalNewSubject').style.display = 'none';
            document.getElementById('modalNewSubject').value = '';
            document.getElementById('modalTopic').value = '';
            document.getElementById('modalQuestion').value = '';
            document.getElementById('modalAnswer').value = '';
            document.getElementById('modalSolution').value = '';
            document.getElementById('modalUniversity').value = 'UNAM';
            document.getElementById('modalNewUniversity').style.display = 'none';
            document.getElementById('modalNewUniversity').value = '';
            
            if (document.getElementById('hasOptionsCheckbox')) {
                document.getElementById('hasOptionsCheckbox').checked = false;
                toggleOptions();
                
                document.getElementById('optionA').value = '';
                document.getElementById('optionB').value = '';
                document.getElementById('optionC').value = '';
                document.getElementById('optionD').value = '';
                
                document.querySelectorAll('input[name="correctOption"]').forEach(radio => {
                    radio.checked = false;
                });
            }
        }
        
        function editQuestion(questionId) {
            const question = allQuestions.find(q => q._id === questionId);
            if (!question) {
                showNotification('Pregunta no encontrada', 'error');
                return;
            }
            
            isEditMode = true;
            currentEditQuestionId = questionId;
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Pregunta';
            document.getElementById('saveQuestionBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Pregunta';
            
            document.getElementById('modalSubject').value = question.subject;
            document.getElementById('modalTopic').value = question.topic;
            document.getElementById('modalQuestion').value = question.question;
            document.getElementById('modalSolution').value = question.solution || '';
            document.getElementById('modalUniversity').value = question.university || 'UNAM';
            
            if (question.has_options && question.options && question.options.length > 0) {
                document.getElementById('hasOptionsCheckbox').checked = true;
                toggleOptions();
                
                document.getElementById('optionA').value = question.options[0] || '';
                document.getElementById('optionB').value = question.options[1] || '';
                document.getElementById('optionC').value = question.options[2] || '';
                document.getElementById('optionD').value = question.options[3] || '';
                
                if (question.correct_option >= 0 && question.correct_option < 4) {
                    const correctRadio = document.getElementById(`correctOption${String.fromCharCode(65 + question.correct_option)}`);
                    if (correctRadio) {
                        correctRadio.checked = true;
                    }
                }
                
                document.getElementById('modalAnswer').value = '';
            } else {
                document.getElementById('hasOptionsCheckbox').checked = false;
                toggleOptions();
                document.getElementById('modalAnswer').value = question.answer || question.correct_answer || '';
            }
            
            document.getElementById('questionModal').classList.add('active');
        }
        
        async function saveQuestion() {
            // Obtener valores
            const subject = document.getElementById('modalSubject').value;
            const newSubject = document.getElementById('modalNewSubject').value.trim();
            const finalSubject = subject === '_new_' && newSubject ? newSubject : subject;
            
            const topic = document.getElementById('modalTopic').value.trim();
            const questionText = document.getElementById('modalQuestion').value.trim();
            
            const universitySelect = document.getElementById('modalUniversity').value;
            const newUniversity = document.getElementById('modalNewUniversity').value.trim();
            const finalUniversity = universitySelect === '_new_' && newUniversity ? newUniversity : universitySelect;
            
            // Validar
            if (!finalSubject || !topic || !questionText) {
                showNotification('Por favor completa todos los campos requeridos', 'error');
                return;
            }
            
            const questionData = {
                subject: finalSubject,
                topic: topic,
                question: questionText,
                university: finalUniversity,
                has_options: document.getElementById('hasOptionsCheckbox').checked,
                solution: document.getElementById('modalSolution').value.trim(),
            };
            
            if (questionData.has_options) {
                const options = [
                    document.getElementById('optionA').value.trim(),
                    document.getElementById('optionB').value.trim(),
                    document.getElementById('optionC').value.trim(),
                    document.getElementById('optionD').value.trim()
                ];
                
                const emptyOptions = options.filter(opt => !opt);
                if (emptyOptions.length > 0) {
                    showNotification('Todas las opciones deben tener texto', 'error');
                    return;
                }
                
                const correctOptionInput = document.querySelector('input[name="correctOption"]:checked');
                if (!correctOptionInput) {
                    showNotification('Debes seleccionar la opci√≥n correcta', 'error');
                    return;
                }
                
                const correctOptionIndex = parseInt(correctOptionInput.value);
                
                questionData.options = options;
                questionData.correct_option = correctOptionIndex;
                questionData.correct_answer = `${String.fromCharCode(65 + correctOptionIndex)}. ${options[correctOptionIndex]}`;
                questionData.answer = '';
            } else {
                const answer = document.getElementById('modalAnswer').value.trim();
                if (!answer) {
                    showNotification('La respuesta es requerida para preguntas abiertas', 'error');
                    return;
                }
                
                questionData.options = [];
                questionData.correct_option = -1;
                questionData.correct_answer = answer;
                questionData.answer = answer;
            }
            
            const saveBtn = document.getElementById('saveQuestionBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner loading"></i> ' + 
                (isEditMode ? 'Actualizando...' : 'Guardando...');
            saveBtn.disabled = true;
            
            try {
                let response;
                let endpoint;
                
                if (isEditMode && currentEditQuestionId) {
                    endpoint = `/api/questions/${currentEditQuestionId}`;
                    response = await fetch(endpoint, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(questionData)
                    });
                } else {
                    endpoint = '/api/questions';
                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(questionData)
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(
                        isEditMode ? '‚úÖ Pregunta actualizada' : '‚úÖ Pregunta guardada', 
                        'success'
                    );
                    closeModal();
                    await loadAllData(); // Recargar datos
                } else {
                    showNotification('‚ùå Error: ' + (data.error || 'Error desconocido'), 'error');
                }
            } catch (error) {
                console.error('Error guardando pregunta:', error);
                showNotification('‚ùå Error de conexi√≥n', 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        function confirmDelete(questionId) {
            questionToDelete = questionId;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        function closeConfirmModal() {
            questionToDelete = null;
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        async function deleteQuestion() {
            if (!questionToDelete) return;
            
            try {
                const response = await fetch(`/api/questions/${questionToDelete}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ Pregunta eliminada', 'success');
                    closeConfirmModal();
                    await loadAllData(); // Recargar datos
                } else {
                    showNotification('‚ùå Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error eliminando pregunta:', error);
                showNotification('‚ùå Error de conexi√≥n', 'error');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
        
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
         }
     }
        
        
        
        
         // Funciones para carga masiva (VERSI√ìN MEJORADA)
    function openBulkModal() {
        document.getElementById('bulkModal').style.display = 'flex';
        document.getElementById('bulkText').value = '';
        document.getElementById('bulkProgressContainer').style.display = 'none';
        document.getElementById('bulkResultContainer').style.display = 'none';
        document.getElementById('bulkPreview').style.display = 'none';
        
        // Resetear valores
        document.getElementById('bulkSubject').value = 'Matem√°ticas';
        document.getElementById('bulkNewSubject').style.display = 'none';
        document.getElementById('bulkNewSubject').value = '';
        document.getElementById('bulkTopic').value = '';
        document.getElementById('bulkUniversity').value = 'UNAM';
        
        // Inicializar evento para materia personalizada
        document.getElementById('bulkSubject').addEventListener('change', function() {
            const newSubjectInput = document.getElementById('bulkNewSubject');
            if (this.value === '_new_') {
                newSubjectInput.style.display = 'block';
                newSubjectInput.focus();
            } else {
                newSubjectInput.style.display = 'none';
            }
        });
        
        // Evento para an√°lisis en tiempo real
        document.getElementById('bulkText').addEventListener('input', function() {
            actualizarEstadisticasBulk();
        });
        
        document.getElementById('bulkText').focus();
    }
    
    function closeBulkModal() {
        document.getElementById('bulkModal').style.display = 'none';
    }
    
    function actualizarEstadisticasBulk() {
        const texto = document.getElementById('bulkText').value.trim();
        const statsElement = document.getElementById('bulkStats');
        const previewElement = document.getElementById('bulkPreview');
        
        if (!texto) {
            statsElement.textContent = '0 preguntas detectadas | 0 l√≠neas';
            previewElement.style.display = 'none';
            return;
        }
        
        // Contar l√≠neas
        const lineas = texto.split('\n').length;
        
        // Estimar preguntas (cada 6 l√≠neas = 1 pregunta aprox)
        const bloques = texto.trim().split('\n\n');
        let preguntasDetectadas = 0;
        
        for (const bloque of bloques) {
            const lineasBloque = bloque.split('\n').filter(l => l.trim()).length;
            if (lineasBloque >= 6) { // Pregunta + 4 opciones + respuesta
                preguntasDetectadas++;
            }
        }
        
        // Mostrar estad√≠sticas
        statsElement.textContent = `${preguntasDetectadas} preguntas detectadas | ${lineas} l√≠neas`;
        
        // Mostrar vista previa de la primera pregunta
        if (preguntasDetectadas > 0) {
            const primerBloque = bloques[0];
            previewElement.style.display = 'block';
            document.getElementById('bulkPreviewContent').innerHTML = `
                <div style="font-family: monospace; white-space: pre-wrap;">
                    ${primerBloque}
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                    <i class="fas fa-info-circle"></i> Esta es la primera pregunta que se procesar√°
                </div>
            `;
        } else {
            previewElement.style.display = 'none';
        }
    }
    
    async function procesarCargaMasiva() {
        const texto = document.getElementById('bulkText').value.trim();
        
        if (!texto) {
            showNotification('Por favor pega las preguntas primero', 'warning');
            return;
        }
        
        // Obtener valores de los selectores
        let subject = document.getElementById('bulkSubject').value;
        const newSubject = document.getElementById('bulkNewSubject').value.trim();
        const finalSubject = (subject === '_new_' && newSubject) ? newSubject : subject;
        
        const topic = document.getElementById('bulkTopic').value.trim();
        const university = document.getElementById('bulkUniversity').value;
        
        // Validaciones
        if (!finalSubject) {
            showNotification('Por favor selecciona o escribe una materia', 'warning');
            return;
        }
        
        if (!topic) {
            showNotification('Por favor escribe el tema para las preguntas', 'warning');
            return;
        }
        
        const processBtn = document.getElementById('processBulkBtn');
        const originalText = processBtn.innerHTML;
        
        // Mostrar progreso
        document.getElementById('bulkProgressContainer').style.display = 'block';
        document.getElementById('bulkResultContainer').style.display = 'none';
        
        processBtn.innerHTML = '<i class="fas fa-spinner loading"></i> Procesando...';
        processBtn.disabled = true;
        
        try {
            updateProgress(10, 'Analizando texto...');
            
            const response = await fetch('/api/bulk_questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    texto: texto,
                    subject: finalSubject,
                    topic: topic,
                    university: university
                })
            });
            
            updateProgress(50, 'Enviando datos al servidor...');
            
            const data = await response.json();
            
            if (data.success) {
                updateProgress(100, '¬°Completado!');
                
                // Mostrar resultados
                const resultContainer = document.getElementById('bulkResultContainer');
                resultContainer.style.display = 'block';
                resultContainer.className = 'result-container result-success';
                
                resultContainer.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <h4>¬°Carga completada exitosamente!</h4>
                        
                        <div style="margin: 15px 0; text-align: left; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
                            <div><strong>Materia:</strong> ${finalSubject}</div>
                            <div><strong>Tema:</strong> ${topic}</div>
                            <div><strong>Universidad:</strong> ${university}</div>
                            <div><strong>Preguntas insertadas:</strong> ${data.inserted_count}</div>
                        </div>
                        
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                            <i class="fas fa-sync-alt"></i> Las preguntas se a√±adieron a la base de datos
                        </p>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-outline btn-sm" onclick="verPreguntasInsertadas(${data.inserted_count})">
                                <i class="fas fa-eye"></i> Ver preguntas
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="cargarMasPreguntas()" style="margin-left: 10px;">
                                <i class="fas fa-plus"></i> Cargar m√°s
                            </button>
                        </div>
                    </div>
                `;
                
                // Limpiar solo el texto, mantener materia y tema por si quieren a√±adir m√°s
                document.getElementById('bulkText').value = '';
                
                showNotification(`‚úÖ Se insertaron ${data.inserted_count} preguntas en ${finalSubject} - ${topic}`, 'success');
                
                // Recargar datos despu√©s de 2 segundos
                setTimeout(() => {
                    loadAllData();
                }, 2000);
                
            } else {
                updateProgress(100, 'Error');
                
                const resultContainer = document.getElementById('bulkResultContainer');
                resultContainer.style.display = 'block';
                resultContainer.className = 'result-container result-error';
                
                resultContainer.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <h4>Error en la carga</h4>
                        <p>${data.error || 'Error desconocido'}</p>
                        
                        ${data.suggestions ? `
                            <div style="margin-top: 15px; text-align: left; font-size: 0.9rem;">
                                <strong>Sugerencias para corregir:</strong>
                                <ul style="margin: 10px 0 0 20px;">
                                    ${data.suggestions.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-outline btn-sm" onclick="document.getElementById('bulkText').focus()">
                                <i class="fas fa-edit"></i> Corregir texto
                            </button>
                        </div>
                    </div>
                `;
                
                showNotification(`‚ùå ${data.error}`, 'error');
            }
            
        } catch (error) {
            console.error('Error en carga masiva:', error);
            
            const resultContainer = document.getElementById('bulkResultContainer');
            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContainer.innerHTML = `
                <div style="text-align: center;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <h4>Error de conexi√≥n</h4>
                    <p>No se pudo conectar con el servidor: ${error.message}</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Verifica tu conexi√≥n a internet e intenta de nuevo.
                    </p>
                </div>
            `;
            
            showNotification('‚ùå Error de conexi√≥n con el servidor', 'error');
            
        } finally {
            processBtn.innerHTML = originalText;
            processBtn.disabled = false;
        }
    }
    
    function verPreguntasInsertadas(cantidad) {
        // Cierra el modal y va a la p√°gina de preguntas
        closeBulkModal();
        
        // Activa la pesta√±a de preguntas
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        
        document.querySelector('.menu-item[data-page="questions"]').classList.add('active');
        document.getElementById('questionsPage').classList.add('active');
        
        // Muestra un mensaje
        showNotification(`Verifica las ${cantidad} preguntas reci√©n a√±adidas`, 'info');
    }
    
    function cargarMasPreguntas() {
        // Limpia solo el √°rea de texto, mantiene los dem√°s valores
        document.getElementById('bulkText').value = '';
        document.getElementById('bulkResultContainer').style.display = 'none';
        document.getElementById('bulkProgressContainer').style.display = 'none';
        document.getElementById('bulkText').focus();
        
        showNotification('Puedes pegar m√°s preguntas', 'info');
    }





    // Funci√≥n para actualizar la barra de progreso (agregar despu√©s de la funci√≥n openBulkModal)
    function updateProgress(porcentaje, mensaje) {
        const progressBar = document.getElementById('bulkProgressBar');
        const progressText = document.getElementById('bulkProgressText');
        
        if (progressBar && progressText) {
            progressBar.style.width = porcentaje + '%';
            progressText.textContent = mensaje + ' ' + porcentaje + '%';
            
            // Cambiar color seg√∫n el progreso
            if (porcentaje < 30) {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #f97316 100%)';
            } else if (porcentaje < 70) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #eab308 100%)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%)';
            }
        }
    }

    function verPreguntasInsertadas(cantidad) {
        closeBulkModal();
        
        // Activar la pesta√±a de preguntas
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        
        const questionsMenuItem = document.querySelector('.menu-item[data-page="questions"]');
        if (questionsMenuItem) {
            questionsMenuItem.classList.add('active');
        }
        document.getElementById('questionsPage').classList.add('active');
        
        showNotification(`Verifica las ${cantidad} preguntas reci√©n a√±adidas`, 'info');
    }


    function closeBulkModal() {
    document.getElementById('bulkModal').style.display = 'none';
}

    // AGREGAR ESTAS FUNCIONES AQU√ç:
    function updateProgress(porcentaje, mensaje) {
        const progressBar = document.getElementById('bulkProgressBar');
        const progressText = document.getElementById('bulkProgressText');
        
        if (progressBar && progressText) {
            progressBar.style.width = porcentaje + '%';
            progressText.textContent = mensaje + ' ' + porcentaje + '%';
            
            // Cambiar color seg√∫n el progreso
            if (porcentaje < 30) {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #f97316 100%)';
            } else if (porcentaje < 70) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #eab308 100%)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%)';
            }
        }
    }
    
    function verPreguntasInsertadas(cantidad) {
        closeBulkModal();
        
        // Activar la pesta√±a de preguntas
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        
        const questionsMenuItem = document.querySelector('.menu-item[data-page="questions"]');
        if (questionsMenuItem) {
            questionsMenuItem.classList.add('active');
        }
        document.getElementById('questionsPage').classList.add('active');
        
        showNotification(`Verifica las ${cantidad} preguntas reci√©n a√±adidas`, 'info');
    }
    
    


        function analizarFormatoTexto(texto) {
            const formatos = {
                formato1: /(.*?)\nA[\).]\s*(.*?)\nB[\).]\s*(.*?)\nC[\).]\s*(.*?)\nD[\).]\s*(.*?)\n.*?[Rr]espuesta:\s*([A-D])/gi,
                formato2: /(\d+\.\s.*?)\n\(A\)\s*(.*?)\n\(B\)\s*(.*?)\n\(C\)\s*(.*?)\n\(D\)\s*(.*?)\n.*?[Cc]orrecta:\s*([A-D])/gi,
                formato3: /(PREGUNTA\s*\d+[\.:]\s*.*?)\nA\.\s*(.*?)\nB\.\s*(.*?)\nC\.\s*(.*?)\nD\.\s*(.*?)\n.*?SOLUCI√ìN:\s*([A-D])/gi
            };
            
            const resultados = {
                formato: null,
                preguntas: []
            };
            
            for (const [formatoName, regex] of Object.entries(formatos)) {
                const matches = [...texto.matchAll(regex)];
                if (matches.length > 0) {
                    resultados.formato = formatoName;
                    resultados.preguntas = matches.map(match => ({
                        pregunta: match[1],
                        opciones: [match[2], match[3], match[4], match[5]],
                        respuesta: match[6]
                    }));
                    break;
                }
            }
            
            return resultados;
        }

    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

</body>
</html>